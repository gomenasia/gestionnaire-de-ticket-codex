{% extends "base.html" %}

{% block title %}Gestion des tickets{% endblock title %}

{% block content %}
  <section class="filters horizontal">
    <form method="get">
      <div class="filter-item">
        <label for="status">Statut</label>
        <select name="status" id="status">
          <option value="all" {% if current_status == 'all' %}selected{% endif %}>Tous</option>
          <option value="en_attente" {% if current_status == 'en_attente' %}selected{% endif %}>En attente</option>
          <option value="en_cours" {% if current_status == 'en_cours' %}selected{% endif %}>En cours</option>
          <option value="resolu" {% if current_status == 'resolu' %}selected{% endif %}>Résolu</option>
        </select>
      </div>

      <div class="filter-item">
        <label for="sort">Tri</label>
        <select name="sort" id="sort">
          <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Plus récents</option>
          <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Plus anciens</option>
        </select>
      </div>

      <div class="filter-item grow">
        <label for="q">Recherche contenu</label>
        <input type="search" id="q" name="q" placeholder="mot clé" value="{{ current_q }}" />
      </div>

      <div class="filter-item grow">
        <label for="author">Auteur</label>
        <input type="search" id="author" name="author" placeholder="nom d'utilisateur" value="{{ current_author }}" />
      </div>

      <div class="filter-item checkbox-item">
        <label class="inline-check" for="overdue">
          <input type="checkbox" id="overdue" name="overdue" value="1" {% if current_overdue %}checked{% endif %} />
          Voir seulement les tickets en retard
        </label>
      </div>

    </form>
  </section>

  <section
    class="ticket-list"
    data-api-url="{{ url_for('api.api_tickets') }}"
    data-user-profile-path="{{ url_for('auth.user_profile', user_id=0)[:-1] }}"
    data-ticket-edit-path="{{ url_for('ticket.edit_ticket', ticket_id=0).replace('/0/edit', '') }}"
    data-ticket-admin-path="{{ url_for('ticket.admin_update_ticket', ticket_id=0).replace('/0/admin', '') }}"
  >
    {% for ticket in tickets %}
      <article class="ticket">
        <div class="ticket-head">
          <h3>{{ ticket.title }}</h3>
          <span class="status {{ ticket.status }}">{{ ticket.status.replace('_', ' ').title() }}</span>
        </div>
        <p>{{ ticket.content }}</p>
        <small>
          Auteur: <a href="{{ url_for('auth.user_profile', user_id=ticket.author.id) }}">{{ ticket.author.username }}</a> · Créé le {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}
        </small>

        {% if ticket.deadline %}
          <div class="deadline {% if ticket.deadline < now and ticket.status != 'resolu' %}late{% endif %}">
            <strong>Échéance:</strong> {{ ticket.deadline.strftime('%d/%m/%Y') }} · {{ format_countdown(ticket.deadline, now) }}
          </div>
        {% endif %}

        {% if g.user and g.user.id == ticket.author_id %}
          <div class="author-actions">
            <a class="link-button" href="{{ url_for('ticket.edit_ticket', ticket_id=ticket.id) }}">Modifier mon ticket</a>
          </div>
        {% endif %}

        {% if ticket.admin_response %}
          <div class="admin-response">
            <strong>Réponse admin:</strong>
            <p>{{ ticket.admin_response }}</p>
          </div>
        {% endif %}

        {% if g.user and g.user.is_admin_user() %}
          <form method="post" action="{{ url_for('ticket.admin_update_ticket', ticket_id=ticket.id) }}" class="admin-form" data-ticket-id="{{ ticket.id }}">
            <select name="status">
              <option value="en_attente" {% if ticket.status == 'en_attente' %}selected{% endif %}>En attente</option>
              <option value="en_cours" {% if ticket.status == 'en_cours' %}selected{% endif %}>En cours</option>
              <option value="resolu" {% if ticket.status == 'resolu' %}selected{% endif %}>Résolu</option>
            </select>
            <textarea name="admin_response" rows="2" placeholder="Réponse administrateur">{{ ticket.admin_response or '' }}</textarea>
            <button type="submit">Mettre à jour</button>
          </form>
        {% endif %}
      </article>
    {% else %}
      <p>Aucun ticket ne correspond à vos critères.</p>
    {% endfor %}
  </section>
{% endblock content %}

{% block scripts %}
<!-- Injecter les infos utilisateur pour JavaScript -->
<script>
  {% if g.user %}
    document.body.dataset.userId = "{{ g.user.id }}";
    document.body.dataset.isAdmin = "{{ 'true' if g.user.is_admin_user() else 'false' }}";
  {% endif %}
</script>

<!-- Script de gestion dynamique des tickets -->
<script src="{{ url_for('static', filename='js/ticket_manager.js') }}"></script>
{% endblock scripts %}
